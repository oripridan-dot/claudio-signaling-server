<!DOCTYPE html>
<html lang="en">
<head>
  <title>Claudio v5.4.0</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root {
      --primary:#3b82f6; --primary-light:rgba(59,130,246,.2); --primary-border:rgba(59,130,246,.4);
      --success:#22c55e; --success-light:rgba(34,197,94,.15); --success-border:rgba(34,197,94,.3);
      --danger:#ef4444; --danger-light:rgba(239,68,68,.15); --danger-border:rgba(239,68,68,.4);
      --warning:#f59e0b;
      --bg-primary:#0a0a0a; --bg-secondary:rgba(20,20,20,.8); --bg-input:rgba(40,40,40,.8);
      --border-primary:rgba(40,40,40,.8); --border-secondary:rgba(60,60,60,.8);
      --text-primary:#fff; --text-secondary:#e0e0e0; --text-muted:#888; --text-disabled:#666;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg-primary);color:var(--text-secondary);min-height:100vh;line-height:1.4;overflow-x:hidden;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .container{max-width:600px;margin:0 auto;padding:20px 20px 100px}
    .header{text-align:center;margin-bottom:30px;padding:20px 0}
    .logo{font-size:clamp(2rem,6vw,2.8rem);font-weight:200;color:var(--text-primary);margin-bottom:8px;letter-spacing:-.02em;
      background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .tagline{font-size:.9rem;color:var(--text-muted)}
    .status-bar{display:flex;align-items:center;justify-content:center;padding:14px 20px;margin-bottom:24px;border-radius:12px;
      font-size:.85rem;font-weight:500;backdrop-filter:blur(10px);transition:all .3s}
    .status-connected{background:var(--success-light);border:1px solid var(--success-border);color:var(--success)}
    .status-disconnected{background:var(--danger-light);border:1px solid var(--danger-border);color:var(--danger)}
    .status-connecting{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.3);color:#fbbf24}
    .status-dot{width:8px;height:8px;border-radius:50%;margin-right:10px;background:currentColor;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .card{background:var(--bg-secondary);backdrop-filter:blur(15px);border:1px solid var(--border-primary);
      border-radius:16px;padding:24px;margin-bottom:20px;transition:all .2s}
    .card:hover{border-color:var(--border-secondary)}
    .card-title{font-size:1.05rem;font-weight:600;color:var(--text-primary);margin-bottom:18px;display:flex;align-items:center;gap:10px}
    .icon{width:18px;height:18px;opacity:.8;flex-shrink:0}
    .input-group{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
    .input-full{grid-column:1/-1}
    input,select{background:var(--bg-input);border:1px solid var(--border-secondary);border-radius:10px;padding:14px 16px;
      color:var(--text-secondary);font-size:.9rem;transition:all .2s;width:100%;font-family:inherit}
    input:focus,select:focus{outline:none;border-color:var(--primary);background:rgba(50,50,50,.8);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    input::placeholder{color:var(--text-disabled)}
    .button-group{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:var(--primary-light);border:1px solid var(--primary-border);color:var(--primary);padding:14px 20px;border-radius:10px;
      font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;flex:1;min-width:120px;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn:hover:not(:disabled){background:rgba(59,130,246,.3);border-color:rgba(59,130,246,.6);transform:translateY(-1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:rgba(107,114,128,.2);border-color:rgba(107,114,128,.4);color:#9ca3af}
    .floating-controls{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:12px;z-index:1000}
    .btn-floating{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .3s;box-shadow:0 4px 20px rgba(0,0,0,.3);backdrop-filter:blur(10px)}
    .btn-talkback{background:var(--danger-light);border:2px solid var(--danger-border);color:var(--danger)}
    .btn-talkback.active{background:rgba(239,68,68,.4);border-color:rgba(239,68,68,.8);animation:recording-pulse 1.5s infinite}
    @keyframes recording-pulse{0%,100%{box-shadow:0 4px 20px rgba(0,0,0,.3),0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 4px 20px rgba(0,0,0,.3),0 0 0 10px rgba(239,68,68,0)}}
    .room-info{font-size:.9rem;color:#b0b0b0;padding:12px 0}
    .user-list{display:grid;gap:10px;margin-top:16px}
    .user-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(50,50,50,.5);
      border-radius:8px;border-left:3px solid var(--primary)}
    .user-name{font-size:.9rem;color:var(--text-secondary);font-weight:500}
    .user-instrument{font-size:.75rem;color:var(--text-muted)}
    .latency-display{display:flex;align-items:center;justify-content:space-between;margin-top:16px;flex-wrap:wrap;gap:12px}
    .latency-value{font-weight:600;font-size:1rem;padding:8px 12px;background:rgba(50,50,50,.5);border-radius:6px;min-width:60px;text-align:center}
    .loading-spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top:2px solid currentColor;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){.container{padding:12px 12px 80px}.header{margin-bottom:20px}.card{padding:20px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">claudio</div>
      <div class="tagline">ultra-low latency music collaboration</div>
    </div>

    <div id="connectionStatus" class="status-bar status-connecting">
      <div class="status-dot"></div><span class="loading-spinner"></span>&nbsp;&nbsp;connecting...
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/><path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3"/>
        </svg> join session
      </div>
      <div class="input-group">
        <input id="roomId" placeholder="room code" value="STUDIO1" maxlength="10" autocomplete="off" autocapitalize="characters">
        <input id="username" placeholder="your name" value="musician" maxlength="20" autocomplete="name">
      </div>
      <div class="input-group">
        <select id="instrument" class="input-full" aria-label="Select your instrument">
          <option value="guitar">üé∏ guitar</option><option value="bass">üé∏ bass</option><option value="drums">ü•Å drums</option>
          <option value="piano">üéπ piano</option><option value="vocals">üé§ vocals</option><option value="violin">üéª violin</option>
          <option value="saxophone">üé∑ saxophone</option><option value="other">üéµ other</option>
        </select>
      </div>
      <div class="button-group">
        <button class="btn" onclick="joinRoom()" id="joinBtn">join</button>
        <button class="btn btn-secondary" onclick="createRoom()" id="createBtn">create</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg> session
      </div>
      <div id="roomInfo" class="room-info">not in a session</div>
      <div id="userList" class="user-list" role="list" aria-label="Connected users"></div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
        </svg> connection
      </div>
      <div class="latency-display">
        <button class="btn btn-secondary" onclick="testLatency()" id="latencyBtn">test latency</button>
        <div id="latencyResult" class="latency-value">-</div>
      </div>
    </div>
  </div>

  <!-- Floating Controls -->
  <div class="floating-controls">
    <button class="btn-floating btn-talkback" id="talkbackBtn"
      onmousedown="startTalkback()" onmouseup="stopTalkback()"
      ontouchstart="startTalkback(event)" ontouchend="stopTalkback(event)" aria-label="Hold to talk">
      üéôÔ∏è
    </button>
  </div>

  <!-- Socket.IO client (same origin) -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ======== Global State ========
    let socket = null;
    let currentRoom = null;
    let isTalking = false;

    // Peer state
    const peers = new Map();            // peerId -> RTCPeerConnection
    const audioSenders = new Map();     // peerId -> RTCRtpSender (audio)
    let localStream = null;             // MediaStream
    let localTrack = null;              // MediaStreamTrack (audio)

    // STUN only for now (TURN later)
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // ======== Socket Setup ========
    function initializeSocket() {
      socket = io({
        transports: ['websocket','polling'],
        timeout: 5000,
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000
      });
      setupSocketListeners();
    }

    function setupSocketListeners() {
      socket.on('connect', () => setStatus('connected','connected to claudio'));
      socket.on('disconnect', () => {
        setStatus('disconnected','disconnected');
        // drop peers and senders
        [...peers.keys()].forEach(closePeer);
      });
      socket.on('connect_error', () => setStatus('disconnected','connection failed'));

      socket.on('joined-room', ({ roomId, users }) => {
        currentRoom = roomId;
        document.getElementById('roomInfo').innerHTML = `in session: <strong>${roomId}</strong>`;
        updateUserList(users);
        // create offers to existing users
        for (const u of users) if (u.id !== socket.id) createOfferTo(u.id);
      });

      socket.on('user-joined', ({ user, users }) => {
        updateUserList(users);
        if (user?.id && user.id !== socket.id) createOfferTo(user.id);
      });

      socket.on('user-left', ({ id }) => closePeer(id));
      socket.on('users-updated', ({ users }) => updateUserList(users));

      // latency probe
      socket.on('pong', (ts) => {
        const latency = Date.now() - ts;
        const color = latency < 20 ? 'var(--success)' : latency < 50 ? 'var(--warning)' : 'var(--danger)';
        document.getElementById('latencyResult').innerHTML = `<span style="color:${color};">${latency}ms</span>`;
      });

      // WebRTC signaling
      socket.on('signal', async ({ from, data }) => {
        let pc = peers.get(from);
        if (!pc) pc = await createPeer(from, false);

        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('signal', { to: from, roomId: currentRoom, data: { sdp: pc.localDescription } });
          }
        } else if (data.candidate) {
          try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch {}
        }
      });
    }

    // ======== UI helpers ========
    function setStatus(status, text){
      const el = document.getElementById('connectionStatus');
      el.className = `status-bar status-${status}`;
      el.innerHTML = `<div class="status-dot"></div>${text}`;
    }
    function showError(msg){ console.error(msg); }

    // ======== Session ========
    function joinRoom(){
      const roomId = document.getElementById('roomId').value.trim().toUpperCase();
      const username = document.getElementById('username').value.trim();
      const instrument = document.getElementById('instrument').value;
      if (!roomId || !username) return showError('enter room + name');
      socket.emit('join-room', { roomId, username, instrument });
    }
    function createRoom(){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let r=''; for (let i=0;i<6;i++) r+=chars[Math.floor(Math.random()*chars.length)];
      document.getElementById('roomId').value = r;
    }
    function updateUserList(users){
      const list = document.getElementById('userList');
      if (!users || users.length===0) { list.innerHTML=''; return; }
      list.innerHTML = users.map(u => `
        <div class="user-item" role="listitem">
          <div>
            <div class="user-name">${escapeHtml(u.username)}</div>
            <div class="user-instrument">${escapeHtml(u.instrument)} ${u.id===socket.id ? '(you)' : ''}</div>
          </div>
          <div>${u.audioEnabled ? 'üîä' : 'üîá'}</div>
        </div>`).join('');
    }
    function testLatency(){
      if (!socket?.connected) return showError('Not connected');
      document.getElementById('latencyResult').innerHTML = '<span class="loading-spinner"></span>';
      socket.emit('ping', Date.now());
      setTimeout(()=>{
        const el=document.getElementById('latencyResult');
        if (el.innerHTML.includes('loading-spinner')) el.innerHTML = '<span style="color:var(--danger)">timeout</span>';
      }, 5000);
    }

    // ======== WebRTC (PTT Mesh, transceiver-first) ========
    async function ensureLocalStream(){
      if (localStream && localTrack) return;
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { channelCount:1, sampleRate:48000, echoCancellation:false, noiseSuppression:false, autoGainControl:false },
        video: false
      });
      localTrack = localStream.getAudioTracks()[0];
    }

    async function createPeer(peerId, isInitiator){
      const pc = new RTCPeerConnection(rtcConfig);
      peers.set(peerId, pc);

      // Pre-create a sendrecv transceiver so receivers are ready and we can swap tracks without renegotiation
      const transceiver = pc.addTransceiver('audio', { direction: 'sendrecv' });
      audioSenders.set(peerId, transceiver.sender); // keep sender handle for replaceTrack()

      pc.onicecandidate = (e) => { if (e.candidate) socket.emit('signal', { to: peerId, roomId: currentRoom, data: { candidate: e.candidate } }); };
      pc.onconnectionstatechange = () => {
        if (['failed','closed','disconnected'].includes(pc.connectionState)) closePeer(peerId);
      };
      pc.ontrack = (e) => attachRemoteAudio(peerId, e.streams[0]);

      if (isInitiator) {
        const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: false });
        await pc.setLocalDescription(offer);
        socket.emit('signal', { to: peerId, roomId: currentRoom, data: { sdp: pc.localDescription } });
      }
      return pc;
    }

    async function createOfferTo(peerId){
      if (peers.has(peerId)) return peers.get(peerId);
      return createPeer(peerId, true);
    }

    function closePeer(peerId){
      const pc = peers.get(peerId);
      if (pc) { try { pc.close(); } catch {} }
      peers.delete(peerId);
      audioSenders.delete(peerId);
      detachRemoteAudio(peerId);
    }

    function attachRemoteAudio(peerId, stream){
      let el = document.getElementById(`audio-${peerId}`);
      if (!el) {
        el = document.createElement('audio');
        el.id = `audio-${peerId}`;
        el.autoplay = true; el.playsInline = true;
        el.style.display = 'none';
        document.body.appendChild(el);
      }
      el.srcObject = stream;
      // Try to start playback (some browsers need explicit call even after user gesture)
      el.play().catch(()=>{ /* ignore autoplay promise rejection; next user gesture will unlock */ });
    }
    function detachRemoteAudio(peerId){
      const el = document.getElementById(`audio-${peerId}`);
      if (el) { el.srcObject = null; el.remove(); }
    }

    // Push-to-talk ‚Äî swap tracks without renegotiation
    async function startTalkback(e){
      if (e) e.preventDefault();
      if (!socket?.connected || !currentRoom) return;
      if (isTalking) return;
      isTalking = true;
      document.getElementById('talkbackBtn').classList.add('active');

      try{
        await ensureLocalStream();
        // put mic on every sender
        audioSenders.forEach(async (sender) => {
          try { await sender.replaceTrack(localTrack); } catch {}
        });
        socket.emit('toggle-audio', true);
      } catch(err){
        showError('mic permission denied'); stopTalkback();
      }
    }

    function stopTalkback(e){
      if (e) e.preventDefault();
      if (!isTalking) return;
      isTalking = false;
      document.getElementById('talkbackBtn').classList.remove('active');

      // remove mic from all senders but keep the transceivers alive
      audioSenders.forEach(async (sender) => {
        try { await sender.replaceTrack(null); } catch {}
      });
      socket.emit('toggle-audio', false);
    }

    // ======== Utils / Events ========
    function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

    document.addEventListener('DOMContentLoaded', () => {
      initializeSocket();

      // small user-gesture helper to unlock audio on first click anywhere
      const unlock = () => {
        document.removeEventListener('click', unlock, true);
        // try playing any remote elements that might be pending
        document.querySelectorAll('audio').forEach(a => a.play().catch(()=>{}));
      };
      document.addEventListener('click', unlock, true);

      // tidy inputs
      const roomIdInput = document.getElementById('roomId');
      roomIdInput.addEventListener('input', (e)=>{
        const v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').substring(0,10);
        if (v !== e.target.value) e.target.value = v;
      });
      document.getElementById('username').addEventListener('blur', e => e.target.value = e.target.value.trim());
    });

    window.addEventListener('beforeunload', () => { if (socket?.connected) socket.disconnect(); });
  </script>
</body>
</html>
