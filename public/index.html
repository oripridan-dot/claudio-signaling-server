<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Claudio ‚Äî sanity test</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#0a0a0a;color:#e5e5e5}
    .wrap{max-width:720px;margin:24px auto;padding:24px}
    h1{margin:0 0 12px 0;font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    input,button,select{background:#171717;color:#e5e5e5;border:1px solid #2a2a2a;border-radius:8px;padding:10px 12px}
    button{cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .log{background:#0d0d0d;border:1px solid #252525;border-radius:8px;padding:8px;height:160px;overflow:auto;font:12px ui-monospace,Menlo,Consolas,monospace;white-space:pre}
    .meter{height:10px;background:#222;border:1px solid #333;border-radius:6px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#43e,#3c8,#fc3,#f44)}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Claudio ‚Äî sanity test</h1>

    <div class="row">
      <input id="room" value="STUDIO1" />
      <input id="name" value="musician" />
      <button id="join">Join</button>
      <button id="ping">Ping</button>
      <span id="rtt">rtt: ‚Äî</span>
    </div>

    <div class="row">
      <select id="mic"></select>
      <select id="out"></select>
      <button id="refresh">Refresh devices</button>
    </div>

    <div class="row">
      <button id="enable">Enable sound</button>
      <button id="talk" disabled>üéôÔ∏è Hold to talk</button>
    </div>

    <div class="row">
      <div class="meter" style="flex:1"><div id="bar" class="bar"></div></div>
    </div>

    <div class="row">
      <div id="log" class="log"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const log = (m,c='')=>{ const el=$('log'); const t=document.createElement('div'); if(c)t.className=c; t.textContent=m; el.appendChild(t); el.scrollTop=el.scrollHeight; };

    let socket, stream, pc, roomId = 'STUDIO1', meter, audioEl;
    const ice = { iceServers: [{urls:'stun:stun.l.google.com:19302'}] };

    async function listDevices(){
      const devs = await navigator.mediaDevices.enumerateDevices();
      const mics = devs.filter(d=>d.kind==='audioinput');
      const outs = devs.filter(d=>d.kind==='audiooutput');
      $('mic').innerHTML = mics.map(d=>`<option value="${d.deviceId}">${d.label||'Mic'}</option>`).join('');
      $('out').innerHTML = outs.map(d=>`<option value="${d.deviceId}">${d.label||'Output'}</option>`).join('');
    }

    async function getMic(){
      const id = $('mic').value || undefined;
      const s = await navigator.mediaDevices.getUserMedia({
        audio: {
          deviceId: id ? {exact:id} : undefined,
          channelCount: 1,
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false,
          sampleRate: 48000,
          sampleSize: 16
        }
      });
      return s;
    }

    function setupLevelMeter(src){
      const ac = new (window.AudioContext||window.webkitAudioContext)();
      const srcNode = ac.createMediaStreamSource(src);
      const analyser = ac.createAnalyser();
      analyser.fftSize = 1024;
      const data = new Uint8Array(analyser.frequencyBinCount);
      srcNode.connect(analyser);
      function tick(){
        analyser.getByteTimeDomainData(data);
        // Compute RMS
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/data.length);
        $('bar').style.width = Math.min(100, (rms*200)).toFixed(1)+'%';
        requestAnimationFrame(tick);
      }
      tick();
    }

    function wireSocket(){
      socket = io({ transports:['websocket','polling'] });
      socket.on('connect', ()=>{ log('socket connected','ok'); });
      socket.on('disconnect', r=> log('socket disconnect: '+r,'warn'));
      socket.on('pong', ts=> $('rtt').textContent = 'rtt: '+(Date.now()-ts)+'ms');
      socket.on('joined-room', ({roomId, users})=>{
        log('joined '+roomId+' users:'+users.length,'ok');
      });
      socket.on('users-updated', ({users})=> log('users: '+users.map(u=>u.username).join(', ')));
      socket.on('signal', async ({from, data})=>{
        if(!pc) return;
        if(data.sdp){
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if(data.sdp.type==='offer'){
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('signal',{to: from, roomId, data:{sdp: pc.localDescription}});
          }
        }else if(data.candidate){
          try{ await pc.addIceCandidate(data.candidate); }catch(e){ log('ice err '+e,'err'); }
        }
      });
    }

    async function join(){
      roomId = $('room').value.trim().toUpperCase();
      const username = $('name').value.trim() || 'musician';
      socket.emit('join-room', {roomId, username, instrument:'guitar'});
    }

    async function enable(){
      try{
        stream = await getMic();
        setupLevelMeter(stream);
        audioEl = document.createElement('audio');
        audioEl.autoplay = true;
        // try to honor chosen output
        if(typeof audioEl.setSinkId === 'function' && $('out').value){
          try{ await audioEl.setSinkId($('out').value); }catch(e){}
        }
        $('talk').disabled = false;
        log('mic ready','ok');
      }catch(e){
        log('enable failed: '+e.message,'err');
      }
    }

    async function makePeer(){
      pc = new RTCPeerConnection(ice);
      pc.onicecandidate = (ev)=>{
        if(ev.candidate){
          socket.emit('signal',{roomId, to:'*', data:{candidate: ev.candidate}});
        }
      };
      pc.ontrack = (ev)=>{
        // play first remote track
        if(audioEl) audioEl.srcObject = ev.streams[0];
      };
    }

    async function talkStart(){
      if(!stream) return;
      if(!pc){ await makePeer(); }
      // add sending track
      if(pc.getSenders().length===0){
        const track = stream.getAudioTracks()[0];
        pc.addTrack(track, stream);
      }
      const offer = await pc.createOffer({offerToReceiveAudio:true});
      await pc.setLocalDescription(offer);
      socket.emit('signal',{roomId, to:'*', data:{sdp: pc.localDescription}});
    }

    function talkStop(){
      if(pc){
        pc.getSenders().forEach(s=>{ try{ pc.removeTrack(s);}catch{} });
        pc.close(); pc = null;
      }
    }

    // UI hooks
    $('refresh').onclick = listDevices;
    $('enable').onclick = enable;
    $('join').onclick = join;
    $('ping').onclick = ()=> socket.emit('ping', Date.now());
    $('talk').onmousedown = talkStart;
    $('talk').onmouseup = talkStop;
    $('talk').ontouchstart = (e)=>{ e.preventDefault(); talkStart(); };
    $('talk').ontouchend = (e)=>{ e.preventDefault(); talkStop(); };

    // boot
    (async ()=>{
      try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch{}
      await listDevices();
      wireSocket();
    })();
  </script>
</body>
</html>
