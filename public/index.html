<!DOCTYPE html>
<html lang="en">
<head>
  <title>Claudio v5.4.0</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root {
      --primary: #3b82f6;
      --primary-light: rgba(59,130,246,.2);
      --primary-border: rgba(59,130,246,.4);
      --success: #22c55e;
      --success-light: rgba(34,197,94,.15);
      --success-border: rgba(34,197,94,.3);
      --danger: #ef4444;
      --danger-light: rgba(239,68,68,.15);
      --danger-border: rgba(239,68,68,.4);
      --warning: #f59e0b;
      --bg-primary: #0a0a0a;
      --bg-secondary: rgba(20,20,20,.8);
      --bg-tertiary: rgba(30,30,30,.8);
      --bg-input: rgba(40,40,40,.8);
      --border-primary: rgba(40,40,40,.8);
      --border-secondary: rgba(60,60,60,.8);
      --text-primary: #fff;
      --text-secondary: #e0e0e0;
      --text-muted: #888;
      --text-disabled: #666;
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{ font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg-primary); color:var(--text-secondary); min-height:100vh; line-height:1.4; overflow-x:hidden;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .container{ max-width:600px; margin:0 auto; padding:20px 20px 100px;}
    .header{ text-align:center; margin-bottom:30px; padding:20px 0;}
    .logo{ font-size:clamp(2rem,6vw,2.8rem); font-weight:200; color:var(--text-primary); margin-bottom:8px; letter-spacing:-.02em;
      background:linear-gradient(135deg,#3b82f6,#8b5cf6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .tagline{ font-size:.9rem; color:var(--text-muted); font-weight:400;}
    .status-bar{ display:flex; align-items:center; justify-content:center; padding:14px 20px; margin-bottom:24px; border-radius:12px;
      font-size:.85rem; font-weight:500; transition:all .3s ease; backdrop-filter:blur(10px);}
    .status-connected{ background:var(--success-light); border:1px solid var(--success-border); color:var(--success);}
    .status-disconnected{ background:var(--danger-light); border:1px solid var(--danger-border); color:var(--danger);}
    .status-connecting{ background:rgba(251,191,36,.15); border:1px solid rgba(251,191,36,.3); color:#fbbf24;}
    .status-dot{ width:8px; height:8px; border-radius:50%; margin-right:10px; background:currentColor; animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .card{ background:var(--bg-secondary); backdrop-filter:blur(15px); border:1px solid var(--border-primary);
      border-radius:16px; padding:24px; margin-bottom:20px; transition:all .2s ease;}
    .card:hover{ border-color:var(--border-secondary);}
    .card-title{ font-size:1.05rem; font-weight:600; color:var(--text-primary); margin-bottom:18px; display:flex; align-items:center; gap:10px;}
    .icon{ width:18px; height:18px; opacity:.8; flex-shrink:0;}
    .input-group{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px;}
    .input-full{ grid-column:1 / -1;}
    input,select{ background:var(--bg-input); border:1px solid var(--border-secondary); border-radius:10px; padding:14px 16px;
      color:var(--text-secondary); font-size:.9rem; transition:all .2s ease; width:100%; font-family:inherit;}
    input:focus,select:focus{ outline:none; border-color:var(--primary); background:rgba(50,50,50,.8); box-shadow:0 0 0 3px rgba(59,130,246,.1);}
    input::placeholder{ color:var(--text-disabled);}
    select{ cursor:pointer;}
    .button-group{ display:flex; gap:12px; flex-wrap:wrap;}
    .btn{ background:var(--primary-light); border:1px solid var(--primary-border); color:var(--primary); padding:14px 20px; border-radius:10px;
      font-size:.85rem; font-weight:500; cursor:pointer; transition:all .2s ease; flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:8px; font-family:inherit; user-select:none;}
    .btn:hover:not(:disabled){ background:rgba(59,130,246,.3); border-color:rgba(59,130,246,.6); transform:translateY(-1px);}
    .btn:active{ transform:translateY(0);}
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none;}
    .btn-secondary{ background:rgba(107,114,128,.2); border-color:rgba(107,114,128,.4); color:#9ca3af;}
    .btn-secondary:hover:not(:disabled){ background:rgba(107,114,128,.3); border-color:rgba(107,114,128,.6);}
    .floating-controls{ position:fixed; bottom:20px; right:20px; display:flex; flex-direction:column; gap:12px; z-index:1000;}
    .btn-floating{ width:56px; height:56px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:all .3s ease; box-shadow:0 4px 20px rgba(0,0,0,.3); backdrop-filter:blur(10px); user-select:none;}
    .btn-talkback{ background:var(--danger-light); border:2px solid var(--danger-border); color:var(--danger);}
    .btn-talkback:hover:not(.active){ background:rgba(239,68,68,.25); transform:scale(1.05);}
    .btn-talkback.active{ background:rgba(239,68,68,.4); border-color:rgba(239,68,68,.8); animation:recording-pulse 1.5s infinite;}
    @keyframes recording-pulse{0%,100%{box-shadow:0 4px 20px rgba(0,0,0,.3),0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 4px 20px rgba(0,0,0,.3),0 0 0 10px rgba(239,68,68,0)}}
    .btn-chat{ background:var(--bg-secondary); border:2px solid var(--border-primary); color:var(--text-secondary);}
    .btn-chat.has-unread{ background:var(--primary-light); border-color:var(--primary-border); color:var(--primary);}
    .notification-badge{ position:absolute; top:-2px; right:-2px; background:var(--danger); color:#fff; border-radius:50%; width:18px; height:18px; font-size:.7rem; display:flex; align-items:center; justify-content:center; font-weight:600;}
    .room-info{ font-size:.9rem; color:#b0b0b0; padding:12px 0;}
    .room-empty{ color:var(--text-disabled); font-style:italic;}
    .user-list{ display:grid; gap:10px; margin-top:16px;}
    .user-item{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:rgba(50,50,50,.5);
      border-radius:8px; border-left:3px solid var(--primary); transition:all .2s ease;}
    .user-item:hover{ background:rgba(60,60,60,.5);}
    .user-info{ flex:1; display:flex; flex-direction:column; gap:2px;}
    .user-name{ font-size:.9rem; color:var(--text-secondary); font-weight:500;}
    .user-instrument{ font-size:.75rem; color:var(--text-muted);}
    .user-controls{ display:flex; align-items:center; gap:8px;}
    .user-audio{ font-size:1.1rem; padding:4px; border-radius:4px; transition:all .2s ease;}
    .user-audio.muted{ opacity:.5;}
    .chat-panel{ position:fixed; top:0; right:-100vw; width:min(400px,100vw); height:100vh; background:rgba(15,15,15,.95);
      backdrop-filter:blur(20px); border-left:1px solid var(--border-primary); transition:right .3s cubic-bezier(.4,0,.2,1); z-index:2000; display:flex; flex-direction:column;}
    .chat-panel.open{ right:0;}
    .chat-header{ padding:20px; border-bottom:1px solid var(--border-primary); display:flex; justify-content:space-between; align-items:center; background:rgba(20,20,20,.8);}
    .chat-title{ font-weight:600; font-size:1.1rem; color:var(--text-primary);}
    .chat-messages{ flex:1; padding:16px; overflow-y:auto; font-size:.85rem; line-height:1.5; scroll-behavior:smooth;}
    .chat-input{ padding:16px; border-top:1px solid var(--border-primary); display:flex; gap:10px; background:rgba(20,20,20,.8);}
    .message{ margin-bottom:12px; padding:8px 0; word-wrap:break-word;}
    .message-time{ color:var(--text-disabled); font-size:.7rem; margin-right:8px; opacity:.8;}
    .message-system{ color:var(--success);} .message-user{ color:var(--primary);} .message-own{ color:#8b5cf6;} .message-error{ color:var(--danger);}
    .latency-display{ display:flex; align-items:center; justify-content:space-between; margin-top:16px; flex-wrap:wrap; gap:12px;}
    .latency-value{ font-weight:600; font-size:1rem; padding:8px 12px; background:rgba(50,50,50,.5); border-radius:6px; min-width:60px; text-align:center;}
    .close-btn{ background:none; border:none; color:var(--text-muted); font-size:1.4rem; cursor:pointer; padding:4px; width:32px; height:32px; border-radius:6px; transition:all .2s ease; display:flex; align-items:center; justify-content:center;}
    .close-btn:hover{ background:rgba(255,255,255,.1); color:var(--text-secondary);}
    .loading-spinner{ display:inline-block; width:12px; height:12px; border:2px solid rgba(255,255,255,.3); border-top:2px solid currentColor; border-radius:50%; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){ .container{padding:12px 12px 80px} .header{margin-bottom:20px;padding:16px 0}
      .logo{font-size:2.2rem} .card{padding:20px;margin-bottom:16px;border-radius:12px} .input-group{grid-template-columns:1fr;gap:10px;margin-bottom:16px}
      input,select{padding:16px;font-size:16px;border-radius:8px} .btn{padding:16px 20px;font-size:.9rem;min-width:100px}
      .floating-controls{bottom:16px;right:16px;gap:10px} .btn-floating{width:52px;height:52px}
      .chat-panel{width:100vw} .chat-header{padding:16px} .chat-messages{padding:12px} .chat-input{padding:12px}
      .user-item{padding:14px} .user-name{font-size:.95rem}}
    @media (max-width:480px){ .container{padding:8px 8px 70px} .logo{font-size:1.8rem} .card{padding:16px}
      .button-group{flex-direction:column} .btn{min-width:100%} .floating-controls{bottom:12px;right:12px} .btn-floating{width:48px;height:48px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">claudio</div>
      <div class="tagline">ultra-low latency music collaboration</div>
    </div>

    <div id="connectionStatus" class="status-bar status-connecting">
      <div class="status-dot"></div><span class="loading-spinner"></span>&nbsp;&nbsp;connecting...
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/><path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3"/>
        </svg> join session
      </div>

      <div class="input-group">
        <input type="text" id="roomId" placeholder="room code" value="STUDIO1" maxlength="10" autocomplete="off" autocorrect="off" autocapitalize="characters">
        <input type="text" id="username" placeholder="your name" value="musician" maxlength="20" autocomplete="name" autocorrect="off">
      </div>

      <div class="input-group">
        <select id="instrument" class="input-full" aria-label="Select your instrument">
          <option value="guitar">🎸 guitar</option>
          <option value="bass">🎸 bass</option>
          <option value="drums">🥁 drums</option>
          <option value="piano">🎹 piano</option>
          <option value="vocals">🎤 vocals</option>
          <option value="violin">🎻 violin</option>
          <option value="saxophone">🎷 saxophone</option>
          <option value="other">🎵 other</option>
        </select>
      </div>

      <div class="button-group">
        <button class="btn" onclick="joinRoom()" id="joinBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"/>
          </svg> join
        </button>
        <button class="btn btn-secondary" onclick="createRoom()" id="createBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg> create
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg> session
      </div>
      <div id="roomInfo" class="room-info room-empty">not in a session</div>
      <div id="userList" class="user-list" role="list" aria-label="Connected users"></div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
        </svg> connection
      </div>
      <div class="latency-display">
        <button class="btn btn-secondary" onclick="testLatency()" id="latencyBtn">test latency</button>
        <div id="latencyResult" class="latency-value">-</div>
      </div>
    </div>
  </div>

  <!-- Floating Controls -->
  <div class="floating-controls">
    <button class="btn-floating btn-chat" onclick="toggleChat()" aria-label="Toggle chat" id="chatToggle">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <div id="chatBadge" class="notification-badge" style="display:none;">0</div>
    </button>

    <button id="talkbackBtn" class="btn-floating btn-talkback"
      onmousedown="startTalkback()" onmouseup="stopTalkback()"
      ontouchstart="startTalkback(event)" ontouchend="stopTalkback(event)" aria-label="Hold to talk">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
    </button>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="chat-panel" role="dialog" aria-labelledby="chatTitle">
    <div class="chat-header">
      <div class="chat-title" id="chatTitle">chat</div>
      <button class="close-btn" onclick="toggleChat()" aria-label="Close chat">×</button>
    </div>
    <div id="chatMessages" class="chat-messages" role="log" aria-live="polite" aria-label="Chat messages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="type message..." onkeydown="handleChatKeydown(event)" maxlength="200" autocomplete="off" aria-label="Chat message input">
      <button class="btn" onclick="sendMessage()" aria-label="Send message">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9 22,2"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Socket.IO client (served by our server at same origin) -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global state
    let socket = null;
    let currentRoom = null;
    let pingTime = 0;
    let isTalking = false;
    let unreadMessages = 0;
    let isChatOpen = false;
    let maxReconnectAttempts = 5;

    function initializeSocket() {
      try {
        socket = io({
          transports: ['websocket', 'polling'],
          timeout: 5000,
          reconnection: true,
          reconnectionAttempts: maxReconnectAttempts,
          reconnectionDelay: 1000
        });
        setupSocketListeners();
      } catch (error) {
        console.error('Failed to initialize socket:', error);
        showError('Connection failed. Please refresh the page.');
      }
    }

    function setupSocketListeners() {
      socket.on('connect', () => {
        updateConnectionStatus('connected', 'connected to claudio');
        addMessage('connected to claudio server', 'system');
        enableControls();
      });

      socket.on('disconnect', (reason) => {
        updateConnectionStatus('disconnected', 'disconnected');
        addMessage(`disconnected: ${reason}`, 'system');
        disableControls();
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        updateConnectionStatus('disconnected', 'connection failed');
        disableControls();
      });

      socket.on('joined-room', (data) => {
        currentRoom = data.roomId;
        document.getElementById('roomInfo').innerHTML = `in session: <strong>${data.roomId}</strong>`;
        document.getElementById('roomInfo').className = 'room-info';
        updateUserList(data.users);
        addMessage(`joined session ${data.roomId}`, 'system');
      });

      socket.on('user-joined', (data) => {
        updateUserList(data.users);
        addMessage(`${data.user.username} joined`, 'user');
      });

      socket.on('user-left', (data) => {
        addMessage(`${data.username || 'user'} left`, 'user');
      });

      socket.on('users-updated', (data) => {
        updateUserList(data.users);
      });

      socket.on('chat-message', (data) => {
        if (data.userId !== socket.id) {
          addMessage(`${data.username}: ${data.message}`, 'user');
          if (!isChatOpen) incrementUnreadMessages();
        }
      });

      socket.on('pong', (timestamp) => {
        const latency = Date.now() - timestamp;
        const color = latency < 20 ? 'var(--success)' : latency < 50 ? 'var(--warning)' : 'var(--danger)';
        document.getElementById('latencyResult').innerHTML = `<span style="color:${color};">${latency}ms</span>`;
      });
    }

    function updateConnectionStatus(status, message) {
      const el = document.getElementById('connectionStatus');
      el.className = `status-bar status-${status}`;
      let content = '<div class="status-dot"></div>';
      if (status === 'connecting') content += '<span class="loading-spinner"></span>&nbsp;&nbsp;';
      content += message;
      el.innerHTML = content;
    }

    function enableControls() {
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('createBtn').disabled = false;
      document.getElementById('latencyBtn').disabled = false;
    }
    function disableControls() {
      document.getElementById('joinBtn').disabled = true;
      document.getElementById('createBtn').disabled = true;
      document.getElementById('latencyBtn').disabled = true;
    }
    function showError(message) { addMessage(message, 'error'); }

    // Room management
    function joinRoom() {
      const roomId = document.getElementById('roomId').value.trim().toUpperCase();
      const username = document.getElementById('username').value.trim();
      const instrument = document.getElementById('instrument').value;

      if (!roomId || !username) return showError('Please enter both room code and name');
      if (roomId.length < 3) return showError('Room code must be at least 3 characters');
      if (username.length < 2) return showError('Name must be at least 2 characters');

      socket.emit('join-room', { roomId, username, instrument });
      addMessage(`attempting to join ${roomId}...`, 'system');
    }

    function createRoom() {
      const roomId = generateRoomCode();
      document.getElementById('roomId').value = roomId;
      addMessage(`created session: ${roomId}`, 'system');
      const usernameInput = document.getElementById('username');
      if (!usernameInput.value.trim()) usernameInput.focus();
    }

    function generateRoomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
      return result;
    }

    function testLatency() {
      if (!socket || !socket.connected) return showError('Not connected to server');
      pingTime = Date.now();
      document.getElementById('latencyResult').innerHTML = '<span class="loading-spinner"></span>';
      socket.emit('ping', pingTime);
      setTimeout(() => {
        const cur = document.getElementById('latencyResult').innerHTML;
        if (cur.includes('loading-spinner')) {
          document.getElementById('latencyResult').innerHTML = '<span style="color: var(--danger);">timeout</span>';
        }
      }, 5000);
    }

    // User list
    function updateUserList(users) {
      const list = document.getElementById('userList');
      if (!users || users.length === 0) { list.innerHTML = ''; return; }
      list.innerHTML = users.map(user => `
        <div class="user-item" role="listitem">
          <div class="user-info">
            <div class="user-name">${escapeHtml(user.username)}</div>
            <div class="user-instrument">${escapeHtml(user.instrument)}</div>
          </div>
          <div class="user-controls">
            <div class="user-audio ${user.audioEnabled ? '' : 'muted'}" title="${user.audioEnabled ? 'Audio enabled' : 'Audio muted'}">
              ${user.audioEnabled ? '🔊' : '🔇'}
            </div>
          </div>
        </div>`).join('');
    }

    // Chat
    function toggleChat() {
      const panel = document.getElementById('chatPanel');
      isChatOpen = !isChatOpen;
      panel.classList.toggle('open', isChatOpen);
      if (isChatOpen) {
        clearUnreadMessages();
        setTimeout(() => document.getElementById('messageInput').focus(), 300);
      }
    }
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;
      if (!socket?.connected) return showError('Not connected to server');
      if (!currentRoom) return showError('Not in a session');
      if (message.length > 200) return showError('Message too long (max 200 characters)');
      socket.emit('chat-message', { message, roomId: currentRoom });
      addMessage(`you: ${message}`, 'own');
      input.value = '';
    }
    function handleChatKeydown(e){ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } else if(e.key==='Escape'){ toggleChat(); } }
    function addMessage(msg, type='info'){
      const messages = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message message-${type}`;
      const time = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      div.innerHTML = `<span class="message-time">${time}</span>${escapeHtml(msg)}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      while (messages.children.length > 100) messages.removeChild(messages.firstChild);
    }
    function incrementUnreadMessages(){ unreadMessages++; updateChatBadge(); }
    function clearUnreadMessages(){ unreadMessages = 0; updateChatBadge(); }
    function updateChatBadge(){
      const badge = document.getElementById('chatBadge');
      const toggle = document.getElementById('chatToggle');
      if (unreadMessages > 0) {
        badge.textContent = unreadMessages > 99 ? '99+' : String(unreadMessages);
        badge.style.display = 'flex'; toggle.classList.add('has-unread');
      } else { badge.style.display = 'none'; toggle.classList.remove('has-unread'); }
    }

    // PTT (UI only for now — ready for WebRTC wiring later)
    function startTalkback(event){
      if(event) event.preventDefault();
      if (!socket?.connected) return;
      if (!isTalking) {
        isTalking = true;
        document.getElementById('talkbackBtn').classList.add('active');
        socket.emit('toggle-audio', true);
        console.log('talkback started');
      }
    }
    function stopTalkback(event){
      if(event) event.preventDefault();
      if (isTalking) {
        isTalking = false;
        document.getElementById('talkbackBtn').classList.remove('active');
        socket.emit('toggle-audio', false);
        console.log('talkback stopped');
      }
    }

    // Utils
    function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
    function formatRoomCode(input){ return input.toUpperCase().replace(/[^A-Z0-9]/g,'').substring(0,10); }

    // Events
    document.addEventListener('DOMContentLoaded', () => {
      initializeSocket();

      const roomIdInput = document.getElementById('roomId');
      roomIdInput.addEventListener('input', (e) => {
        const formatted = formatRoomCode(e.target.value);
        if (e.target.value !== formatted) e.target.value = formatted;
      });

      const usernameInput = document.getElementById('username');
      usernameInput.addEventListener('blur', (e) => e.target.value = e.target.value.trim());

      document.getElementById('talkbackBtn').addEventListener('contextmenu', e => e.preventDefault());
      document.getElementById('talkbackBtn').addEventListener('touchstart', startTalkback, { passive:false });
      document.getElementById('talkbackBtn').addEventListener('touchend', stopTalkback, { passive:false });

      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isChatOpen) toggleChat(); });

      if (roomIdInput.value) usernameInput.focus(); else roomIdInput.focus();
    });

    window.addEventListener('beforeunload', () => { if (socket?.connected) socket.disconnect(); });
    document.addEventListener('touchstart', () => {
      const meta = document.querySelector('meta[name=viewport]');
      meta.content = 'width=device-width, initial-scale=1.0, user-scalable=no';
    });
  </script>
</body>
</html>
